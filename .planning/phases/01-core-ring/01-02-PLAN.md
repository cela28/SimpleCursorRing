---
phase: 01-core-ring
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - SimpleCursorRing/Core.lua
autonomous: true

must_haves:
  truths:
    - "Ring size changes when slider value changes (20-200px range)"
    - "Ring color changes when color picker selection changes"
    - "Class color toggle applies player's class color to ring"
    - "All settings persist across game sessions (logout/login)"
  artifacts:
    - path: "SimpleCursorRing/Core.lua"
      provides: "Settings initialization and customization functions"
      contains: "SimpleCursorRingSaved"
  key_links:
    - from: "SimpleCursorRing/Core.lua"
      to: "SavedVariables"
      via: "ADDON_LOADED event"
      pattern: "ADDON_LOADED"
    - from: "SimpleCursorRing/Core.lua"
      to: "RAID_CLASS_COLORS"
      via: "class color lookup"
      pattern: "RAID_CLASS_COLORS"
---

<objective>
Add settings persistence and ring customization (size, color, class color).

Purpose: Implement RING-02 (size slider), RING-03 (color picker), and RING-04 (class color toggle). Settings persist via SavedVariables so user preferences survive logout/login.

Output: Fully customizable ring with persistent settings, ready for Settings UI in Phase 2.
</objective>

<execution_context>
@/home/sntanavaras/.claude/get-shit-done/workflows/execute-plan.md
@/home/sntanavaras/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-ring/01-RESEARCH.md
@.planning/phases/01-core-ring/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SavedVariables initialization</name>
  <files>SimpleCursorRing/Core.lua</files>
  <action>
    Modify Core.lua to add SavedVariables initialization:

    1. Define default settings table:
       ```lua
       local defaults = {
           size = 64,
           color = {r = 1, g = 1, b = 1, a = 1},
           useClassColor = false
       }
       ```

    2. Create ADDON_LOADED event handler:
       - Create event frame: local eventFrame = CreateFrame("Frame")
       - Register event: eventFrame:RegisterEvent("ADDON_LOADED")
       - In OnEvent handler, check if loadedAddon == "SimpleCursorRing"
       - If so, unregister event and call initialization function

    3. Initialize SavedVariables with defaults:
       ```lua
       local function InitializeSavedVariables()
           if not SimpleCursorRingSaved then
               SimpleCursorRingSaved = {}
           end
           -- Apply defaults for missing keys
           for key, value in pairs(defaults) do
               if SimpleCursorRingSaved[key] == nil then
                   if type(value) == "table" then
                       SimpleCursorRingSaved[key] = {}
                       for k, v in pairs(value) do
                           SimpleCursorRingSaved[key][k] = v
                       end
                   else
                       SimpleCursorRingSaved[key] = value
                   end
               end
           end
       end
       ```

    4. After initialization, apply saved settings to ring:
       - Call UpdateRingSize(SimpleCursorRingSaved.size)
       - Call UpdateRingColor() (checks useClassColor flag)

    IMPORTANT: SavedVariables are nil until ADDON_LOADED fires. Do NOT access SimpleCursorRingSaved during file load.

    Pattern from research (01-RESEARCH.md Pattern 1: Addon Initialization with ADDON_LOADED)
  </action>
  <verify>
    - grep "ADDON_LOADED" SimpleCursorRing/Core.lua returns matches
    - grep "SimpleCursorRingSaved" SimpleCursorRing/Core.lua returns matches
    - grep "defaults" SimpleCursorRing/Core.lua shows default settings table
  </verify>
  <done>
    - SavedVariables initialized with defaults on first load
    - Existing settings preserved on subsequent loads
    - Settings applied to ring after ADDON_LOADED
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement size, color, and class color controls</name>
  <files>SimpleCursorRing/Core.lua</files>
  <action>
    Add customization functions to Core.lua:

    1. UpdateRingSize function (RING-02):
       ```lua
       local function UpdateRingSize(size)
           -- Clamp to valid range
           size = math.max(20, math.min(200, size))
           SimpleCursorRingSaved.size = size
           ringFrame:SetSize(size, size)
       end
       ```
       - Accepts size in pixels (20-200 range)
       - Updates SavedVariables
       - Applies to frame with SetSize()

    2. UpdateRingColor function (RING-03, RING-04):
       ```lua
       local function UpdateRingColor(r, g, b, a)
           if SimpleCursorRingSaved.useClassColor then
               -- Get player's class color
               local _, class = UnitClass("player")
               local classColor = CUSTOM_CLASS_COLORS and CUSTOM_CLASS_COLORS[class] or RAID_CLASS_COLORS[class]
               ringTexture:SetVertexColor(classColor.r, classColor.g, classColor.b, 1.0)
           else
               -- Use custom color
               r = r or SimpleCursorRingSaved.color.r
               g = g or SimpleCursorRingSaved.color.g
               b = b or SimpleCursorRingSaved.color.b
               a = a or SimpleCursorRingSaved.color.a
               SimpleCursorRingSaved.color = {r = r, g = g, b = b, a = a}
               ringTexture:SetVertexColor(r, g, b, a)
           end
       end
       ```
       - When useClassColor is true, gets color from RAID_CLASS_COLORS (with CUSTOM_CLASS_COLORS fallback for addon compatibility)
       - When false, uses saved custom color
       - Updates SavedVariables and applies to texture

    3. SetUseClassColor function (RING-04 toggle):
       ```lua
       local function SetUseClassColor(enabled)
           SimpleCursorRingSaved.useClassColor = enabled
           UpdateRingColor()
       end
       ```
       - Toggles between class color and custom color
       - Immediately updates ring appearance

    4. Expose functions globally for Settings UI (Phase 2):
       ```lua
       SimpleCursorRing = SimpleCursorRing or {}
       SimpleCursorRing.UpdateRingSize = UpdateRingSize
       SimpleCursorRing.UpdateRingColor = UpdateRingColor
       SimpleCursorRing.SetUseClassColor = SetUseClassColor
       ```

    5. Store references for functions to access:
       - local ringFrame (the main frame)
       - local ringTexture (the texture on frame)

    AVOID:
    - Hardcoding class colors (use RAID_CLASS_COLORS table)
    - Ignoring CUSTOM_CLASS_COLORS (breaks compatibility with class color addons)
    - Not clamping size values (could create unusable ring)
  </action>
  <verify>
    - grep "UpdateRingSize" SimpleCursorRing/Core.lua returns function definition
    - grep "UpdateRingColor" SimpleCursorRing/Core.lua returns function definition
    - grep "SetUseClassColor" SimpleCursorRing/Core.lua returns function definition
    - grep "RAID_CLASS_COLORS" SimpleCursorRing/Core.lua returns match
    - grep "CUSTOM_CLASS_COLORS" SimpleCursorRing/Core.lua returns match
  </verify>
  <done>
    - RING-02: UpdateRingSize accepts 20-200px, updates frame and SavedVariables
    - RING-03: UpdateRingColor accepts RGBA, updates texture and SavedVariables
    - RING-04: SetUseClassColor toggles class color mode
    - Functions exposed globally for Phase 2 Settings UI
    - Class color respects CUSTOM_CLASS_COLORS addon if present
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. SavedVariables ready:
   - ADDON_LOADED handler initializes SimpleCursorRingSaved
   - Default values applied for missing keys
   - Saved settings applied to ring on load

2. Size control (RING-02):
   - UpdateRingSize function exists
   - Clamps input to 20-200 range
   - Updates both frame and SavedVariables

3. Color control (RING-03):
   - UpdateRingColor function exists
   - Updates texture SetVertexColor
   - Saves RGBA to SimpleCursorRingSaved.color

4. Class color (RING-04):
   - SetUseClassColor function exists
   - Uses RAID_CLASS_COLORS with CUSTOM_CLASS_COLORS fallback
   - Toggle stored in SimpleCursorRingSaved.useClassColor

5. Global API for Phase 2:
   - SimpleCursorRing.UpdateRingSize accessible
   - SimpleCursorRing.UpdateRingColor accessible
   - SimpleCursorRing.SetUseClassColor accessible
</verification>

<success_criteria>
- RING-02 complete: Size adjustable 20-200px, persists
- RING-03 complete: Color customizable via RGBA, persists
- RING-04 complete: Class color toggle works, persists
- All settings survive logout/login via SavedVariables
- API exposed for Settings UI (Phase 2)
- Phase 1 complete: All 4 requirements implemented
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-ring/01-02-SUMMARY.md`
</output>
